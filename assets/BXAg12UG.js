var le=Object.defineProperty;var ce=(s,e,c)=>e in s?le(s,e,{enumerable:!0,configurable:!0,writable:!0,value:c}):s[e]=c;var Y=(s,e,c)=>ce(s,typeof e!="symbol"?e+"":e,c);import{v as re,x as U,o as C,c as R,a as f,F as Z,q as ee,y as j,z as K,t as $,n as te,d as ie,p as ue,_ as oe,A as de,r as I,B as he,C as G,b as J,w as se,D as Q}from"./C8EwnwJK.js";class ge{constructor(){Y(this,"history",[]);Y(this,"currentIndex",0);this.history.push([])}get canUndo(){return this.currentIndex>0}get canRedo(){return this.currentIndex<this.history.length-1}push(e){if(this.currentIndex>=0&&JSON.stringify(this.history[this.currentIndex])===JSON.stringify(e))return;const c=e.map(d=>d.type==="line"?{...d,points:[...d.points]}:{...d});this.history=this.history.slice(0,this.currentIndex+1),this.history.push(c),this.currentIndex++}undo(){return this.canUndo?(this.currentIndex--,this.history[this.currentIndex].map(e=>e.type==="line"?{...e,points:[...e.points]}:{...e})):[]}redo(){return this.canRedo?(this.currentIndex++,this.history[this.currentIndex].map(e=>e.type==="line"?{...e,points:[...e.points]}:{...e})):this.history[this.currentIndex]||[]}clear(){this.history=[[]],this.currentIndex=0}getCurrentState(){var e;return((e=this.history[this.currentIndex])==null?void 0:e.map(c=>c.type==="line"?{...c,points:[...c.points]}:{...c}))||[]}}const ve=()=>new ge,pe=(s,e,c)=>{const[d,m]=s,[p,u]=e,[t,n]=c,r=Math.abs((n-u)*d-(t-p)*m+t*u-n*p),b=Math.sqrt(Math.pow(n-u,2)+Math.pow(t-p,2));return r/b},ne=(s,e)=>{if(s.length<4)return s;let c=0,d=0;const m=[s[0],s[1]],p=[s[s.length-2],s[s.length-1]];for(let u=2;u<s.length-2;u+=2){const t=pe([s[u],s[u+1]],m,p);t>c&&(c=t,d=u)}if(c>e){const u=ne(s.slice(0,d+2),e),t=ne(s.slice(d,s.length),e);return u.slice(0,-2).concat(t)}return[...m,...p]},ae=(s,e=1)=>ne(s,e),fe=async(s,e,c=30,d="#0000FF")=>{const m=s.toDataURL(),p=new Image;p.src=m,await new Promise(v=>{p.onload=v});const u=document.createElement("canvas");u.width=s.width(),u.height=s.height();const t=u.getContext("2d");if(!t)return null;t.drawImage(p,0,0);const n=t.getImageData(0,0,u.width,u.height),r=n.data,b=n.width,k=n.height,_=Math.round(e.x),D=Math.round(e.y);if(_<0||_>=b||D<0||D>=k)return null;const x=new Set,q=[[_,D]],T=(D*b+_)*4,O=r[T],S=r[T+1],H=r[T+2],X=r[T+3],z=parseInt(d.slice(1,3),16),W=parseInt(d.slice(3,5),16),E=parseInt(d.slice(5,7),16),V=(v,y,a,o)=>{const i=Math.abs(v-O),h=Math.abs(y-S),g=Math.abs(a-H),w=Math.abs(o-X),l=c/100*255;return i<=l&&h<=l&&g<=l&&w<=l},P=document.createElement("canvas");P.width=b,P.height=k;const B=P.getContext("2d");if(!B)return null;B.clearRect(0,0,b,k);const A=B.createImageData(b,k),M=A.data;for(;q.length>0;){const[v,y]=q.pop(),a=`${v},${y}`;if(x.has(a))continue;x.add(a);const o=(y*b+v)*4;if(V(r[o],r[o+1],r[o+2],r[o+3])){M[o]=z,M[o+1]=W,M[o+2]=E,M[o+3]=128;const i=[[v+1,y],[v-1,y],[v,y+1],[v,y-1],[v+1,y+1],[v+1,y-1],[v-1,y+1],[v-1,y-1]];for(const[h,g]of i)h<0||h>=b||g<0||g>=k||x.has(`${h},${g}`)||q.push([h,g])}}B.putImageData(A,0,0);const L=new Image;return L.src=P.toDataURL(),await new Promise(v=>{L.onload=v}),L},me={class:"tools"},ye={class:"tool-group"},we=["onClick"],be={key:0,class:"brush-size"},ke=["aria-label"],Ie={class:"size-display"},$e={key:1,class:"tolerance-slider"},Ce=["aria-label"],_e={class:"tolerance-display"},xe={class:"tool-group"},Re=["aria-label"],De={class:"file-input"},Me=["disabled","aria-label"],Ue=["disabled","aria-label"],Te=["aria-label"],Se=re({__name:"DrawingTools",props:{tools:{type:Array,required:!0},selectedTool:{type:String,required:!0},strokeWidth:{type:Number,required:!0},strokeColor:{type:String,required:!0},colorTolerance:{type:Number,required:!0,default:30},canUndo:{type:Boolean,required:!0},canRedo:{type:Boolean,required:!0}},emits:["select-tool","update:stroke-width","update:stroke-color","update:color-tolerance","upload-image","undo","redo","clear"],setup(s,{emit:e}){const c=s,d=e,m=U({get:()=>c.strokeWidth,set:t=>d("update:stroke-width",t)}),p=U({get:()=>c.strokeColor,set:t=>d("update:stroke-color",t)}),u=U({get:()=>c.colorTolerance,set:t=>d("update:color-tolerance",t)});return(t,n)=>(C(),R("div",me,[f("div",ye,[(C(!0),R(Z,null,ee(s.tools,r=>(C(),R("button",{key:r.name,class:ue({active:s.selectedTool===r.name}),onClick:b=>t.$emit("select-tool",r.name)},$(r.icon)+" "+$(t.$t(`tools.${r.name}`)),11,we))),128))]),s.selectedTool==="brush"?(C(),R("div",be,[j(f("input",{type:"range","onUpdate:modelValue":n[0]||(n[0]=r=>m.value=r),min:"1",max:"50","aria-label":t.$t("settings.brushSize")},null,8,ke),[[K,m.value,void 0,{number:!0}]]),f("span",Ie,$(m.value)+$(t.$t("settings.px")),1)])):te("",!0),s.selectedTool==="magicwand"?(C(),R("div",$e,[j(f("input",{type:"range","onUpdate:modelValue":n[1]||(n[1]=r=>u.value=r),min:"0",max:"100",step:"1","aria-label":t.$t("settings.toleranceSlider")},null,8,Ce),[[K,u.value,void 0,{number:!0}]]),f("span",_e,$(t.$t("settings.tolerance"))+": "+$(u.value)+$(t.$t("settings.percent")),1)])):te("",!0),f("div",xe,[j(f("input",{type:"color","onUpdate:modelValue":n[2]||(n[2]=r=>p.value=r),"aria-label":t.$t("settings.colorPicker")},null,8,Re),[[K,p.value]]),f("label",De,[ie($(t.$t("tools.upload"))+" ",1),f("input",{type:"file",accept:"image/*",onChange:n[3]||(n[3]=r=>t.$emit("upload-image",r)),style:{display:"none"}},null,32)]),f("button",{onClick:n[4]||(n[4]=r=>t.$emit("undo")),disabled:!s.canUndo,"aria-label":t.$t("tools.undo")},$(t.$t("tools.undo")),9,Me),f("button",{onClick:n[5]||(n[5]=r=>t.$emit("redo")),disabled:!s.canRedo,"aria-label":t.$t("tools.redo")},$(t.$t("tools.redo")),9,Ue),f("button",{onClick:n[6]||(n[6]=r=>t.$emit("clear")),"aria-label":t.$t("tools.clear")},$(t.$t("tools.clear")),9,Te)])]))}}),Pe=oe(Se,[["__scopeId","data-v-9b272b23"]]),Be={class:"drawing-board"},qe=3,ze=re({__name:"DrawingBoard",setup(s){const e=de({width:800,height:600}),c=[{name:"brush",icon:"🖌️"},{name:"eraser",icon:"⌫"},{name:"magicwand",icon:"✨"}],d=I("brush"),m=I("#000000"),p=I(5),u=I(30),t=I(!1),n=I([]),r=I(null),b=I(null),k=I(null),_=ve(),D=I({canUndo:!1,canRedo:!1}),x=()=>{D.value={canUndo:_.canUndo,canRedo:_.canRedo}},q=U(()=>D.value.canUndo),T=U(()=>D.value.canRedo),O=(a,o)=>Math.sqrt(Math.pow(o.x-a.x,2)+Math.pow(o.y-a.y,2)),S=I(null),H=I({image:null,width:0,height:0,x:0,y:0}),X=a=>{if(t.value){t.value=!1,k.value=null;const o=n.value[n.value.length-1];if((o==null?void 0:o.type)==="line"&&o.points.length>4){const i=ae(o.points);n.value=[...n.value.slice(0,-1),{...o,points:i}]}z()}d.value=a},z=()=>{_.push([...n.value]),x()},W=async a=>{t.value=!0;const o=a.target.getStage(),i=o.getPointerPosition();if(d.value==="magicwand"){const g=await fe(o,i,u.value,m.value);g&&(n.value=[...n.value,{id:Date.now(),type:"magicwand",image:g,color:m.value}],z()),t.value=!1;return}k.value=i;const h={id:Date.now(),points:[i.x,i.y],color:d.value==="eraser"?"#ffffff":m.value,width:d.value==="eraser"?20:p.value,type:"line"};n.value=[...n.value,h]},E=a=>{if(!t.value)return;const i=a.target.getStage().getPointerPosition();if(k.value&&O(k.value,i)<qe)return;const h=n.value[n.value.length-1];if(h.type!=="line")return;const g=[...h.points,i.x,i.y];n.value=[...n.value.slice(0,-1),{...h,points:g}],k.value=i},V=()=>{if(!t.value)return;t.value=!1,k.value=null;const a=n.value[n.value.length-1];if((a==null?void 0:a.type)==="line"&&a.points.length>4){const o=ae(a.points);n.value=[...n.value.slice(0,-1),{...a,points:o}]}z()},P=()=>{const a=_.undo();n.value=[...a],x()},B=()=>{const a=_.redo();n.value=[...a],x()},A=()=>{n.value=[],_.clear(),x()},M=a=>{const o=e.width,i=e.height,h=a.width/a.height,g=o/i;let w=0,l=0,N=0,F=0;h>g?(w=o,l=o/h,F=(i-l)/2):(l=i,w=i*h,N=(o-w)/2),H.value={image:a,width:w,height:l,x:N,y:F}},L=async a=>{var g;const o=a.target;if(!((g=o.files)!=null&&g.length))return;const i=o.files[0],h=new FileReader;h.onload=async w=>{var N;const l=new Image;l.src=(N=w.target)==null?void 0:N.result,await new Promise(F=>{l.onload=()=>{S.value=l,M(l),F(!0)}})},h.readAsDataURL(i)},v=U(()=>n.value.filter(a=>a.type==="magicwand")),y=U(()=>n.value.filter(a=>a.type==="line"));return he(()=>{x();const a=()=>{var w;if(!((w=r.value)!=null&&w.$el))return;const o=r.value.$el.closest(".drawing-container");if(!o)return;const i=document.querySelector(".tools"),h=i?i.getBoundingClientRect().height:0,g=o.getBoundingClientRect();e.width=g.width,e.height=g.height-h-20,S.value&&M(S.value)};return a(),window.addEventListener("resize",a),()=>{window.removeEventListener("resize",a)}}),(a,o)=>{const i=G("v-image"),h=G("v-line"),g=G("v-layer"),w=G("v-stage");return C(),R("div",Be,[J(Pe,{tools:c,"selected-tool":d.value,"stroke-width":p.value,"stroke-color":m.value,"color-tolerance":u.value,"can-undo":q.value,"can-redo":T.value,onSelectTool:X,"onUpdate:strokeWidth":o[0]||(o[0]=l=>p.value=l),"onUpdate:strokeColor":o[1]||(o[1]=l=>m.value=l),"onUpdate:colorTolerance":o[2]||(o[2]=l=>u.value=l),onUploadImage:L,onUndo:P,onRedo:B,onClear:A},null,8,["selected-tool","stroke-width","stroke-color","color-tolerance","can-undo","can-redo"]),J(w,{ref_key:"stageRef",ref:r,config:e,onMousedown:W,onMousemove:E,onMouseup:V,onTouchstart:W,onTouchmove:E,onTouchend:V},{default:se(()=>[J(g,{ref_key:"layerRef",ref:b},{default:se(()=>[S.value?(C(),Q(i,{key:0,config:H.value},null,8,["config"])):te("",!0),(C(!0),R(Z,null,ee(v.value,l=>(C(),Q(i,{key:l.id,config:{image:l.image,x:0,y:0,width:e.width,height:e.height,opacity:.7}},null,8,["config"]))),128)),(C(!0),R(Z,null,ee(y.value,l=>(C(),Q(h,{key:l.id,config:{points:l.points,stroke:l.color,strokeWidth:l.width,tension:.5,lineCap:"round",lineJoin:"round",opacity:.5}},null,8,["config"]))),128))]),_:1},512)]),_:1},8,["config"])])}}}),Le=oe(ze,[["__scopeId","data-v-46d2126b"]]),Ne={},He={class:"drawing-page"},We={class:"drawing-container"};function Ee(s,e){const c=Le;return C(),R("div",He,[f("h1",null,[e[0]||(e[0]=f("span",{class:"star left"},"🌟",-1)),ie(" "+$(s.$t("drawing.title"))+" ",1),e[1]||(e[1]=f("span",{class:"star right"},"🌟",-1))]),f("div",We,[J(c)]),e[2]||(e[2]=f("div",{class:"kawaii-footer"}," ₍ᐢ. ̫ .ᐢ₎ ",-1))])}const Fe=oe(Ne,[["render",Ee],["__scopeId","data-v-b58d478f"]]);export{Fe as default};
